Option Compare Database


Private Sub Form_Load()
txt_SelectionCount.Value = 0
Me.Check_selectAll.Value = 0
Me.Check_btnNoBatch = 0
Me.Check_1st = 0
Me.Check_2nd = 0
Me.cmb_BatchView.Value = Null
Me.Cmb_StatusView.Value = Null
Me.txt_displayed = "All WES tests currently in progress"
End Sub


Private Sub Form_Current()
Dim unsel As String
Dim selTotal As Long
Dim AllTotal As Long

' Deselct all selected samples
Check_selectAll.Value = False
Me.txt_displayed = "All Approved WES tests sent to the Lab"
    unsel = "UPDATE NGSTest INNER JOIN Patients ON NGSTest.InternalPatientID = Patients.InternalPatientID SET NGSTest.Selection = 0 WHERE NGSTest.StatusID <> 1202218787 And Patients.s_StatusOverall = 1202218798"
    DoCmd.SetWarnings False
    DoCmd.RunSQL unsel
    Form![s87020_ExomeLabList].Requery
    DoCmd.SetWarnings True

'refresh selection count
AllTotal = DCount("NGSTestID", "s87020_ListWESSamples")
Me.txt_TotalTally = AllTotal
selTotal = DCount("[Selection]", "s87020_ListWESSamples", "[Selection] = -1")
Me.txt_SelectionCount = selTotal

End Sub


Private Sub Check_selectAll_Click()
Dim sel As String
Dim unsel As String
Dim selTotal As Long

' 1) check if samples are viewed by unassigned to WES batch button
' 2) check if samples are viewed by require checker 1 button
' 3) check if samples are viewed by require checker 2 button
' 4) check if samples are viewed WES batch
' 5) check if samples are viewedby status
' 6) check if samples are viewed by WES batch AND Status
' 7) Else View ALL pending If (Check_selectAll) = -1 Then 'INNER JOIN Patients ON NGSTest.InternalPatientID = Patients.InternalPatientID
'SQL update WHERE clause depends on selection = only relevant samples are selected.

' 1)
If Check_btnNoBatch = -1 Then
    If Check_selectAll = -1 Then
        sel = "UPDATE NGSTest INNER JOIN Patients ON NGSTest.InternalPatientID = Patients.InternalPatientID SET NGSTest.Selection = -1 WHERE NGSTest.StatusID <> 1202218787 And Patients.s_StatusOverall = 1202218798 AND NGSTest.WESBatch is Null"
        DoCmd.SetWarnings False
        DoCmd.RunSQL sel
        Form![s87020_ExomeLabList].Requery
        DoCmd.SetWarnings True
    Else
        unsel = "UPDATE NGSTest INNER JOIN Patients ON NGSTest.InternalPatientID = Patients.InternalPatientID SET NGSTest.Selection = 0 WHERE NGSTest.StatusID <> 1202218787 And Patients.s_StatusOverall = 1202218798"
        DoCmd.SetWarnings False
        DoCmd.RunSQL unsel
        Form![s87020_ExomeLabList].Requery
        DoCmd.SetWarnings True
    End If
' 2)
ElseIf Check_1st = -1 Then
    If Check_selectAll = -1 Then
        sel = "UPDATE NGSTest INNER JOIN Patients ON NGSTest.InternalPatientID = Patients.InternalPatientID SET NGSTest.Selection = -1 WHERE NGSTest.StatusID <> 1202218787 And Patients.s_StatusOverall = 1202218798 AND NGSTest.check1ID is Null"
        ' MIGHT require a status clause in where
        DoCmd.SetWarnings False
        DoCmd.RunSQL sel
        Form![s87020_ExomeLabList].Requery
        DoCmd.SetWarnings True
    Else
        unsel = "UPDATE NGSTest INNER JOIN Patients ON NGSTest.InternalPatientID = Patients.InternalPatientID SET NGSTest.Selection = 0 WHERE NGSTest.StatusID <> 1202218787 And Patients.s_StatusOverall = 1202218798"
        DoCmd.SetWarnings False
        DoCmd.RunSQL unsel
        Form![s87020_ExomeLabList].Requery
        DoCmd.SetWarnings True
    End If
' 3)
ElseIf Check_2nd = -1 Then
    If Check_selectAll = -1 Then
        sel = "UPDATE NGSTest INNER JOIN Patients ON NGSTest.InternalPatientID = Patients.InternalPatientID SET NGSTest.Selection = -1 WHERE NGSTest.StatusID <> 1202218787 And Patients.s_StatusOverall = 1202218798 AND NGSTest.check1ID is not Null AND NGSTest.check2ID is Null"
        DoCmd.SetWarnings False
        DoCmd.RunSQL sel
        Form![s87020_ExomeLabList].Requery
        DoCmd.SetWarnings True
    Else
        unsel = "UPDATE NGSTest INNER JOIN Patients ON NGSTest.InternalPatientID = Patients.InternalPatientID SET NGSTest.Selection = 0 WHERE NGSTest.StatusID <> 1202218787 And Patients.s_StatusOverall = 1202218798"
        DoCmd.SetWarnings False
        DoCmd.RunSQL unsel
        Form![s87020_ExomeLabList].Requery
        DoCmd.SetWarnings True
    End If
' 4)
ElseIf Not IsNull(cmb_BatchView) Then
    If Check_selectAll = -1 Then
        sel = "UPDATE NGSTest INNER JOIN Patients ON NGSTest.InternalPatientID = Patients.InternalPatientID SET NGSTest.Selection = -1 WHERE NGSTest.StatusID <> 1202218787 And Patients.s_StatusOverall = 1202218798 AND NGSTest.WESBatch = " & Me![cmb_BatchView] & ";"
        DoCmd.SetWarnings False
        DoCmd.RunSQL sel
        Form![s87020_ExomeLabList].Requery
        DoCmd.SetWarnings True
    Else
        unsel = "UPDATE NGSTest INNER JOIN Patients ON NGSTest.InternalPatientID = Patients.InternalPatientID SET NGSTest.Selection = 0 WHERE NGSTest.StatusID <> 1202218787 And Patients.s_StatusOverall = 1202218798"
        DoCmd.SetWarnings False
        DoCmd.RunSQL unsel
        Form![s87020_ExomeLabList].Requery
        DoCmd.SetWarnings True
    End If
' 5)
ElseIf Not IsNull(Cmb_StatusView) Then
    If Check_selectAll = -1 Then
        sel = "UPDATE NGSTest INNER JOIN Patients ON NGSTest.InternalPatientID = Patients.InternalPatientID SET NGSTest.Selection = -1 WHERE NGSTest.StatusID <> 1202218787 And Patients.s_StatusOverall = 1202218798 AND NGSTest.statusid = " & Me![Cmb_StatusView] & ";"
        DoCmd.SetWarnings False
        DoCmd.RunSQL sel
        Form![s87020_ExomeLabList].Requery
        DoCmd.SetWarnings True
    Else
        unsel = "UPDATE NGSTest INNER JOIN Patients ON NGSTest.InternalPatientID = Patients.InternalPatientID SET NGSTest.Selection = 0 WHERE NGSTest.StatusID <> 1202218787 And Patients.s_StatusOverall = 1202218798"
        DoCmd.SetWarnings False
        DoCmd.RunSQL unsel
        Form![s87020_ExomeLabList].Requery
        DoCmd.SetWarnings True
    End If
' 6)
ElseIf Not IsNull(Cmb_StatusView) And Not IsNull(cmb_BatchView) Then
    If Check_selectAll = -1 Then
        sel = "UPDATE NGSTest INNER JOIN Patients ON NGSTest.InternalPatientID = Patients.InternalPatientID SET NGSTest.Selection = -1 WHERE NGSTest.StatusID <> 1202218787 And Patients.s_StatusOverall = 1202218798 AND NGSTest.statusid = " & Me![Cmb_StatusView] & " AND NGSTest.WESBatch = " & Me![cmb_BatchView] & ";"
        DoCmd.SetWarnings False
        DoCmd.RunSQL sel
        Form![s87020_ExomeLabList].Requery
        DoCmd.SetWarnings True
    Else
        unsel = "UPDATE NGSTest INNER JOIN Patients ON NGSTest.InternalPatientID = Patients.InternalPatientID SET NGSTest.Selection = 0 WHERE NGSTest.StatusID <> 1202218787 And Patients.s_StatusOverall = 1202218798"
        DoCmd.SetWarnings False
        DoCmd.RunSQL unsel
        Form![s87020_ExomeLabList].Requery
        DoCmd.SetWarnings True
    End If
' 7)
Else
    If Check_selectAll = -1 Then
        sel = "UPDATE NGSTest INNER JOIN Patients ON NGSTest.InternalPatientID = Patients.InternalPatientID SET NGSTest.Selection = -1 WHERE NGSTest.StatusID <> 1202218787 And NGSTest.StatusID <> 4 And NGSTest.StatusID <>1202218816"
        DoCmd.SetWarnings False
        DoCmd.RunSQL sel
        Form![s87020_ExomeLabList].Requery
        DoCmd.SetWarnings True
    Else
        unsel = "UPDATE NGSTest INNER JOIN Patients ON NGSTest.InternalPatientID = Patients.InternalPatientID SET NGSTest.Selection = 0 WHERE NGSTest.StatusID <> 1202218787 And Patients.s_StatusOverall = 1202218798"
        DoCmd.SetWarnings False
        DoCmd.RunSQL unsel
        Form![s87020_ExomeLabList].Requery
        DoCmd.SetWarnings True
    End If
End If

'refresh selection count
selTotal = DCount("[Selection]", "s87020_ListWESSamples", "[Selection] = -1")
Me.txt_SelectionCount = selTotal

End Sub


Private Sub btn_ViewAll_Click()
Dim unsel As String
Dim subfrmSQL As String
Dim AllTotal As Long


' deselect any selected files and set the select all check box to empty
unsel = "UPDATE NGSTest INNER JOIN Patients ON NGSTest.InternalPatientID = Patients.InternalPatientID SET NGSTest.Selection = 0 WHERE NGSTest.StatusID <> 1202218787 And Patients.s_StatusOverall = 1202218798"
    DoCmd.SetWarnings False
    DoCmd.RunSQL unsel
    Form![s87020_ExomeLabList].Requery
    DoCmd.SetWarnings True
    
' reload subform calling querey to view all
           
subfrmSQL = "SELECT NGSTest.Selection, Patients.PatientID AS PRU, NGSTest.NGSTestID, dbo_Patient_table.LastName, dbo_Patient_table.FirstName, dbo_Patient_table.DoB, gw_GenderTable.GenderShort, Referral.Referral, NGSTest.DateRequested, Checker.Name AS RefName, Checker.Initials AS Referrer, NGSPanel.Panel AS PanelA, NGSPanel_1.Panel AS PanelB, Status_1.StatusID AS PatientStatus, WESBatch.BatchName AS WESBatch, Status.StatusID, Status.Status AS TestStatus, NGSTest.ResultComment, Patients.InternalPatientID, Checker_1.Initials AS Checker1, NGSTest.Check1Date, Checker_2.Initials AS Checker2, NGSTest.Check2Date, Checker_3.Initials AS ReportApproved, NGSTest.Check3Date " & _
            "FROM (((((((((((((NGSTest INNER JOIN Patients ON NGSTest.InternalPatientID = Patients.InternalPatientID) INNER JOIN Referral ON NGSTest.ReferralID = Referral.ReferralID) INNER JOIN Checker ON NGSTest.BookBy = Checker.Check1ID) INNER JOIN NGSPanel ON NGSTest.NGSPanelID = NGSPanel.NGSPanelID) LEFT JOIN NGSPanel AS NGSPanel_1 ON NGSTest.NGSPanelID_B = NGSPanel_1.NGSPanelID) INNER JOIN Status ON NGSTest.StatusID = Status.StatusID) INNER JOIN dbo_Patient_table ON Patients.PatientID = dbo_Patient_table.PatientTrustID) LEFT JOIN DNA ON NGSTest.DNA = DNA.DNANumber) INNER JOIN Status AS Status_1 ON Patients.s_StatusOverall = Status_1.StatusID) LEFT JOIN gw_GenderTable ON dbo_Patient_table.GenderID = gw_GenderTable.GenderID) LEFT JOIN WESBatch ON NGSTest.WESBatch = WESBatch.ID) LEFT JOIN Checker AS Checker_1 ON NGSTest.Check1ID = Checker_1.Check1ID) LEFT JOIN Checker AS Checker_2 ON NGSTest.Check2ID = Checker_2.Check1ID) LEFT JOIN Checker AS Checker_3 ON NGSTest.Check3ID = Checker_3.Check1ID " & _
            "WHERE (((Status.StatusID)<>1202218787 And (Status.StatusID)<>4 And (Status.StatusID)<>1202218816)) " & _
            "ORDER BY NGSTest.DateRequested;"
            
[Form_s87020_ExomeLabList].Form.RecordSource = subfrmSQL

'refresh selection and total count
AllTotal = DCount("NGSTestID", "s87020_ListWESSamples")
Me.txt_TotalTally = AllTotal
selTotal = DCount("[Selection]", "s87020_ListWESSamples", "[Selection] = -1")
Me.txt_SelectionCount = selTotal

' Update summary of displayed samples and refresh search criteria
    Me.Check_selectAll.Value = 0
    Me.Check_btnNoBatch = 0
    Me.Check_1st.Value = 0
    Me.Check_2nd = 0
    Me.cmb_BatchView.Value = Null
    Me.Cmb_StatusView.Value = Null
Me.txt_displayed = "All WES tests currently in progress"
End Sub


Private Sub btn_NoWESBatch_Click()
Dim unsel As String
Dim subfrmSQL As String
Dim AllTotal As Long
Dim strCriteria As String

Me.Check_btnNoBatch.Value = -1

' deselect any selected files and set the select all check box to empty
unsel = "UPDATE NGSTest INNER JOIN Patients ON NGSTest.InternalPatientID = Patients.InternalPatientID SET NGSTest.Selection = 0 WHERE NGSTest.StatusID <> 1202218787 And Patients.s_StatusOverall = 1202218798"
    DoCmd.SetWarnings False
    DoCmd.RunSQL unsel
    Form![s87020_ExomeLabList].Requery
    DoCmd.SetWarnings True
    
    Me.Check_selectAll.Value = 0
    Me.Check_1st.Value = 0
    Me.Check_2nd.Value = 0
    Me.cmb_BatchView.Value = Null
    Me.Cmb_StatusView.Value = Null
    
' reload subform calling querey to view samples not assigned to a WES batch
subfrmSQL = "SELECT NGSTest.Selection, Patients.PatientID AS PRU, NGSTest.NGSTestID, dbo_Patient_table.LastName, dbo_Patient_table.FirstName, dbo_Patient_table.DoB, gw_GenderTable.GenderShort, Referral.Referral, NGSTest.DateRequested, Checker.Name AS RefName, Checker.Initials AS Referrer, NGSPanel.Panel AS PanelA, NGSPanel_1.Panel AS PanelB, Status_1.StatusID AS PatientStatus, WESBatch.BatchName AS WESBatch, Status.StatusID, Status.Status AS TestStatus, NGSTest.ResultComment, Patients.InternalPatientID, Checker_1.Initials AS Checker1, NGSTest.Check1Date, Checker_2.Initials AS Checker2, NGSTest.Check2Date, Checker_3.Initials AS ReportApproved, NGSTest.Check3Date " & _
            "FROM (((((((((((((NGSTest INNER JOIN Patients ON NGSTest.InternalPatientID = Patients.InternalPatientID) INNER JOIN Referral ON NGSTest.ReferralID = Referral.ReferralID) INNER JOIN Checker ON NGSTest.BookBy = Checker.Check1ID) INNER JOIN NGSPanel ON NGSTest.NGSPanelID = NGSPanel.NGSPanelID) LEFT JOIN NGSPanel AS NGSPanel_1 ON NGSTest.NGSPanelID_B = NGSPanel_1.NGSPanelID) INNER JOIN Status ON NGSTest.StatusID = Status.StatusID) INNER JOIN dbo_Patient_table ON Patients.PatientID = dbo_Patient_table.PatientTrustID) LEFT JOIN DNA ON NGSTest.DNA = DNA.DNANumber) INNER JOIN Status AS Status_1 ON Patients.s_StatusOverall = Status_1.StatusID) LEFT JOIN gw_GenderTable ON dbo_Patient_table.GenderID = gw_GenderTable.GenderID) LEFT JOIN WESBatch ON NGSTest.WESBatch = WESBatch.ID) LEFT JOIN Checker AS Checker_1 ON NGSTest.Check1ID = Checker_1.Check1ID) LEFT JOIN Checker AS Checker_2 ON NGSTest.Check2ID = Checker_2.Check1ID) LEFT JOIN Checker AS Checker_3 ON NGSTest.Check3ID = Checker_3.Check1ID " & _
            "WHERE (((Status_1.StatusID) = 1202218798) And ((Status.StatusID) = 1202218803)) " & _
            "ORDER BY NGSTest.DateRequested;"
[Form_s87020_ExomeLabList].Form.RecordSource = subfrmSQL

'refresh selection count
strCriteria = "statusID = 1202218803"
AllTotal = DCount("NGSTestID", "s87020_ListWESSamples", strCriteria)
Debug.Print AllTotal
Me.txt_TotalTally = AllTotal

selTotal = DCount("[Selection]", "s87020_ListWESSamples", "[Selection] = -1")
Me.txt_SelectionCount = selTotal
' Update summary of displayed samples
Me.txt_displayed = "All Approved WES tests not yet assigned to a WES batch"
End Sub


Private Sub btn_req1stCheck_Click()
Dim unsel As String
Dim subfrmSQL As String
Dim strCriteria As String
Dim AllTotal As Long
 ' Update summary of displayed samples and refresh search criteria
    Me.Check_selectAll.Value = 0
    Me.Check_btnNoBatch = 0
    Me.Check_1st = -1
    Me.Check_2nd = 0
    Me.cmb_BatchView.Value = Null
    Me.Cmb_StatusView.Value = Null
    Me.txt_displayed = "All WES tests awaiting primary analysis (check 1)"

' deselect any selected files and set the select all check box to empty
unsel = "UPDATE NGSTest INNER JOIN Patients ON NGSTest.InternalPatientID = Patients.InternalPatientID SET NGSTest.Selection = 0 WHERE NGSTest.StatusID <> 1202218787 And Patients.s_StatusOverall = 1202218798"
    DoCmd.SetWarnings False
    DoCmd.RunSQL unsel
    Form![s87020_ExomeLabList].Requery
    DoCmd.SetWarnings True
    
' reload subform calling querey to view all test pending second check
subfrmSQL = "SELECT NGSTest.Selection, Patients.PatientID AS PRU, NGSTest.NGSTestID, dbo_Patient_table.LastName, dbo_Patient_table.FirstName, dbo_Patient_table.DoB, gw_GenderTable.GenderShort, Referral.Referral, NGSTest.DateRequested, Checker.Name AS RefName, Checker.Initials AS Referrer, NGSPanel.Panel AS PanelA, NGSPanel_1.Panel AS PanelB, Status_1.StatusID AS PatientStatus, WESBatch.BatchName AS WESBatch, Status.StatusID, Status.Status AS TestStatus, NGSTest.ResultComment, Patients.InternalPatientID, Checker_1.Initials AS Checker1, NGSTest.Check1Date, Checker_2.Initials AS Checker2, NGSTest.Check2Date, Checker_3.Initials AS ReportApproved, NGSTest.Check3Date " & _
            "FROM (((((((((((((NGSTest INNER JOIN Patients ON NGSTest.InternalPatientID = Patients.InternalPatientID) INNER JOIN Referral ON NGSTest.ReferralID = Referral.ReferralID) INNER JOIN Checker ON NGSTest.BookBy = Checker.Check1ID) INNER JOIN NGSPanel ON NGSTest.NGSPanelID = NGSPanel.NGSPanelID) LEFT JOIN NGSPanel AS NGSPanel_1 ON NGSTest.NGSPanelID_B = NGSPanel_1.NGSPanelID) INNER JOIN Status ON NGSTest.StatusID = Status.StatusID) INNER JOIN dbo_Patient_table ON Patients.PatientID = dbo_Patient_table.PatientTrustID) LEFT JOIN DNA ON NGSTest.DNA = DNA.DNANumber) INNER JOIN Status AS Status_1 ON Patients.s_StatusOverall = Status_1.StatusID) LEFT JOIN gw_GenderTable ON dbo_Patient_table.GenderID = gw_GenderTable.GenderID) LEFT JOIN WESBatch ON NGSTest.WESBatch = WESBatch.ID) LEFT JOIN Checker AS Checker_1 ON NGSTest.Check1ID = Checker_1.Check1ID) LEFT JOIN Checker AS Checker_2 ON NGSTest.Check2ID = Checker_2.Check1ID) LEFT JOIN Checker AS Checker_3 ON NGSTest.Check3ID = Checker_3.Check1ID " & _
            "WHERE (((Status_1.StatusID) = 1202218798) And ((Status.StatusID) <> 1202218787)) And checker_1.Initials Is Null " & _
            "ORDER BY NGSTest.DateRequested;"

' ADD TO WHERE CLAUSE -->  And ((status.status) = somethng approperate))
[Form_s87020_ExomeLabList].Form.RecordSource = subfrmSQL

'refresh selection and total count
strCriteria = " Checker1 is Null " ' AND TestStatus = ' somethng approperate' "
AllTotal = DCount("NGSTestID", "s87020_ListWESSamples", strCriteria)
'Debug.Print AllTotal
Me.txt_TotalTally = AllTotal

selTotal = DCount("[Selection]", "s87020_ListWESSamples", "[Selection] = -1")
Me.txt_SelectionCount = selTotal

End Sub


Private Sub btn_req2ndCheck_Click()
Dim unsel As String
Dim subfrmSQL As String
Dim strCriteria As String
Dim AllTotal As Long
 ' Update summary of displayed samples and refresh search criteria
    Me.Check_selectAll.Value = 0
    Me.Check_btnNoBatch = 0
    Me.Check_1st = 0
    Me.Check_2nd = -1
    Me.cmb_BatchView.Value = Null
    Me.Cmb_StatusView.Value = Null
    Me.txt_displayed = "All WES tests requiring second check"

' deselect any selected files and set the select all check box to empty
unsel = "UPDATE NGSTest INNER JOIN Patients ON NGSTest.InternalPatientID = Patients.InternalPatientID SET NGSTest.Selection = 0 WHERE NGSTest.StatusID <> 1202218787 And Patients.s_StatusOverall = 1202218798"
    DoCmd.SetWarnings False
    DoCmd.RunSQL unsel
    Form![s87020_ExomeLabList].Requery
    DoCmd.SetWarnings True
    
' reload subform calling querey to view all test pending second check
subfrmSQL = "SELECT NGSTest.Selection, Patients.PatientID AS PRU, NGSTest.NGSTestID, dbo_Patient_table.LastName, dbo_Patient_table.FirstName, dbo_Patient_table.DoB, gw_GenderTable.GenderShort, Referral.Referral, NGSTest.DateRequested, Checker.Name AS RefName, Checker.Initials AS Referrer, NGSPanel.Panel AS PanelA, NGSPanel_1.Panel AS PanelB, Status_1.StatusID AS PatientStatus, WESBatch.BatchName AS WESBatch, Status.StatusID, Status.Status AS TestStatus, NGSTest.ResultComment, Patients.InternalPatientID, Checker_1.Initials AS Checker1, NGSTest.Check1Date, Checker_2.Initials AS Checker2, NGSTest.Check2Date, Checker_3.Initials AS ReportApproved, NGSTest.Check3Date " & _
            "FROM (((((((((((((NGSTest INNER JOIN Patients ON NGSTest.InternalPatientID = Patients.InternalPatientID) INNER JOIN Referral ON NGSTest.ReferralID = Referral.ReferralID) INNER JOIN Checker ON NGSTest.BookBy = Checker.Check1ID) INNER JOIN NGSPanel ON NGSTest.NGSPanelID = NGSPanel.NGSPanelID) LEFT JOIN NGSPanel AS NGSPanel_1 ON NGSTest.NGSPanelID_B = NGSPanel_1.NGSPanelID) INNER JOIN Status ON NGSTest.StatusID = Status.StatusID) INNER JOIN dbo_Patient_table ON Patients.PatientID = dbo_Patient_table.PatientTrustID) LEFT JOIN DNA ON NGSTest.DNA = DNA.DNANumber) INNER JOIN Status AS Status_1 ON Patients.s_StatusOverall = Status_1.StatusID) LEFT JOIN gw_GenderTable ON dbo_Patient_table.GenderID = gw_GenderTable.GenderID) LEFT JOIN WESBatch ON NGSTest.WESBatch = WESBatch.ID) LEFT JOIN Checker AS Checker_1 ON NGSTest.Check1ID = Checker_1.Check1ID) LEFT JOIN Checker AS Checker_2 ON NGSTest.Check2ID = Checker_2.Check1ID) LEFT JOIN Checker AS Checker_3 ON NGSTest.Check3ID = Checker_3.Check1ID " & _
            "WHERE (((Status_1.StatusID) = 1202218798) And ((Status.StatusID) <> 1202218787)) AND (((Checker_1.Initials) Is Not Null) And ((Checker_2.Initials) Is Null)) " & _
            "ORDER BY NGSTest.DateRequested;"
[Form_s87020_ExomeLabList].Form.RecordSource = subfrmSQL

'refresh selection and total count
strCriteria = " Checker1 is not null And  Checker2 is Null "
AllTotal = DCount("NGSTestID", "s87020_ListWESSamples", strCriteria)
'Debug.Print AllTotal
Me.txt_TotalTally = AllTotal

selTotal = DCount("[Selection]", "s87020_ListWESSamples", "[Selection] = -1")
Me.txt_SelectionCount = selTotal

End Sub


Private Sub cmb_BatchView_Click()
Dim unsel As String
Dim subfrmSQL As String
Dim AllTotal As Long
Dim strCriteria As String


' deselect any selected files and set the select all check box to empty
unsel = "UPDATE NGSTest INNER JOIN Patients ON NGSTest.InternalPatientID = Patients.InternalPatientID SET NGSTest.Selection = 0 WHERE NGSTest.StatusID <> 1202218787 And Patients.s_StatusOverall = 1202218798"
    DoCmd.SetWarnings False
    DoCmd.RunSQL unsel
    Form![s87020_ExomeLabList].Requery
    DoCmd.SetWarnings True


' Update summary of displayed samples and refresh search criteria
    Me.Check_selectAll.Value = 0
    Me.Check_btnNoBatch = 0
    Me.Check_1st = 0
    Me.Check_2nd = 0
    
' reload subform calling querey to view samples are assigned to selected WES batch
' if status selection  = null do normal SQL
If Not IsNull(Me!cmb_BatchView) Then
    If IsNull(Cmb_StatusView) Then
        subfrmSQL = "SELECT NGSTest.Selection, Patients.PatientID AS PRU, NGSTest.NGSTestID, dbo_Patient_table.LastName, dbo_Patient_table.FirstName, dbo_Patient_table.DoB, gw_GenderTable.GenderShort, Referral.Referral, NGSTest.DateRequested, Checker.Name AS RefName, Checker.Initials AS Referrer, NGSPanel.Panel AS PanelA, NGSPanel_1.Panel AS PanelB, Status_1.StatusID AS PatientStatus, WESBatch.BatchName AS WESBatch, Status.StatusID, Status.Status AS TestStatus, NGSTest.ResultComment, Patients.InternalPatientID, Checker_1.Initials AS Checker1, NGSTest.Check1Date, Checker_2.Initials AS Checker2, NGSTest.Check2Date, Checker_3.Initials AS ReportApproved, NGSTest.Check3Date " & _
                    "FROM (((((((((((((NGSTest INNER JOIN Patients ON NGSTest.InternalPatientID = Patients.InternalPatientID) INNER JOIN Referral ON NGSTest.ReferralID = Referral.ReferralID) INNER JOIN Checker ON NGSTest.BookBy = Checker.Check1ID) INNER JOIN NGSPanel ON NGSTest.NGSPanelID = NGSPanel.NGSPanelID) LEFT JOIN NGSPanel AS NGSPanel_1 ON NGSTest.NGSPanelID_B = NGSPanel_1.NGSPanelID) INNER JOIN Status ON NGSTest.StatusID = Status.StatusID) INNER JOIN dbo_Patient_table ON Patients.PatientID = dbo_Patient_table.PatientTrustID) LEFT JOIN DNA ON NGSTest.DNA = DNA.DNANumber) INNER JOIN Status AS Status_1 ON Patients.s_StatusOverall = Status_1.StatusID) LEFT JOIN gw_GenderTable ON dbo_Patient_table.GenderID = gw_GenderTable.GenderID) LEFT JOIN WESBatch ON NGSTest.WESBatch = WESBatch.ID) LEFT JOIN Checker AS Checker_1 ON NGSTest.Check1ID = Checker_1.Check1ID) LEFT JOIN Checker AS Checker_2 ON NGSTest.Check2ID = Checker_2.Check1ID) LEFT JOIN Checker AS Checker_3 ON NGSTest.Check3ID = Checker_3.Check1ID " & _
                    "WHERE ((Status_1.StatusID) = 1202218798) And ((Status.StatusID) <> 1202218787) And NGSTest.WESBatch = " & CStr(Me![cmb_BatchView]) & " " & _
                    "ORDER BY NGSTest.DateRequested;"
                    
        'Debug.Print subfrmSQL
        [Form_s87020_ExomeLabList].Form.RecordSource = subfrmSQL
        Me.txt_displayed = "Batch " + Me![cmb_BatchView].Column(1)
        
        ' refresh total tally
        strCriteria = " WESBatch = '" & Me.cmb_BatchView.Column(1) & "'"
        AllTotal = DCount("WESBatch", "s87020_ListWESSamples", strCriteria)
        Me.txt_TotalTally = AllTotal
        'Debug.Print strCriteria
        'Debug.Print AllTotal
        
    ' else display the subform filtered on batch and status option if a status has aready been selected
    Else
        subfrmSQL = "SELECT NGSTest.Selection, Patients.PatientID AS PRU, NGSTest.NGSTestID, dbo_Patient_table.LastName, dbo_Patient_table.FirstName, dbo_Patient_table.DoB, gw_GenderTable.GenderShort, Referral.Referral, NGSTest.DateRequested, Checker.Name AS RefName, Checker.Initials AS Referrer, NGSPanel.Panel AS PanelA, NGSPanel_1.Panel AS PanelB, Status_1.StatusID AS PatientStatus, WESBatch.BatchName AS WESBatch, Status.StatusID, Status.Status AS TestStatus, NGSTest.ResultComment, Patients.InternalPatientID, Checker_1.Initials AS Checker1, NGSTest.Check1Date, Checker_2.Initials AS Checker2, NGSTest.Check2Date, Checker_3.Initials AS ReportApproved, NGSTest.Check3Date " & _
                    "FROM (((((((((((((NGSTest INNER JOIN Patients ON NGSTest.InternalPatientID = Patients.InternalPatientID) INNER JOIN Referral ON NGSTest.ReferralID = Referral.ReferralID) INNER JOIN Checker ON NGSTest.BookBy = Checker.Check1ID) INNER JOIN NGSPanel ON NGSTest.NGSPanelID = NGSPanel.NGSPanelID) LEFT JOIN NGSPanel AS NGSPanel_1 ON NGSTest.NGSPanelID_B = NGSPanel_1.NGSPanelID) INNER JOIN Status ON NGSTest.StatusID = Status.StatusID) INNER JOIN dbo_Patient_table ON Patients.PatientID = dbo_Patient_table.PatientTrustID) LEFT JOIN DNA ON NGSTest.DNA = DNA.DNANumber) INNER JOIN Status AS Status_1 ON Patients.s_StatusOverall = Status_1.StatusID) LEFT JOIN gw_GenderTable ON dbo_Patient_table.GenderID = gw_GenderTable.GenderID) LEFT JOIN WESBatch ON NGSTest.WESBatch = WESBatch.ID) LEFT JOIN Checker AS Checker_1 ON NGSTest.Check1ID = Checker_1.Check1ID) LEFT JOIN Checker AS Checker_2 ON NGSTest.Check2ID = Checker_2.Check1ID) LEFT JOIN Checker AS Checker_3 ON NGSTest.Check3ID = Checker_3.Check1ID " & _
                    "WHERE ((Status_1.StatusID) = 1202218798) And NGSTest.WESBatch = " & CStr(Me![cmb_BatchView]) & " AND Status.StatusID = " & CStr(Cmb_StatusView) & " " & _
                    "ORDER BY NGSTest.DateRequested;"
                    
        'Debug.Print subfrmSQL
        [Form_s87020_ExomeLabList].Form.RecordSource = subfrmSQL
        Me.txt_displayed = "Batch " + Me![cmb_BatchView].Column(1) + " with status " + Me![Cmb_StatusView].Column(1)
    
        ' refresh total tally
        strCriteria = " WESBatch = '" & Me.cmb_BatchView.Column(1) & "' AND TestStatus = '" & Me.Cmb_StatusView.Column(1) & "'"
        AllTotal = DCount("WESBatch", "s87020_ListWESSamples", strCriteria)
        Me.txt_TotalTally = AllTotal
        'Debug.Print strCriteria
        'Debug.Print AllTotal
        
    End If
End If

'refresh selection count
selTotal = DCount("[Selection]", "s87020_ListWESSamples", "[Selection] = -1")
Me.txt_SelectionCount = selTotal
End Sub


Private Sub cmb_BatchView_AfterUpdate()
' If WES batch filter is set to NULL update the subform to reflect the filtering criteria
' Either via status search or view all
If IsNull(cmb_BatchView) Then
    If Not IsNull(Cmb_StatusView) Then
        Call cmb_StatusView_Click
Else
    Call btn_ViewAll_Click
    End If
End If
End Sub


Private Sub btn_Clear1_Click()
' clears user entry for batch view
Me.cmb_BatchView = Null
Call cmb_BatchView_AfterUpdate
End Sub


Private Sub cmb_StatusView_Click()
Dim unsel As String
Dim subfrmSQL As String
Dim AllTotal As Long
Dim strCriteria As String

' deselect any selected files and set the select all check box to empty
unsel = "UPDATE NGSTest INNER JOIN Patients ON NGSTest.InternalPatientID = Patients.InternalPatientID SET NGSTest.Selection = 0 WHERE NGSTest.StatusID <> 1202218787 And Patients.s_StatusOverall = 1202218798"
    DoCmd.SetWarnings False
    DoCmd.RunSQL unsel
    Form![s87020_ExomeLabList].Requery
    DoCmd.SetWarnings True
    
' Update summary of displayed samples and refresh search criteria
    Me.Check_selectAll.Value = 0
    Me.Check_btnNoBatch = 0
    Me.Check_1st = 0
    Me.Check_2nd = 0
    
' reload subform calling querey to view samples are assigned to selected status
' if WES batch filter = null do normal SQL
If Not IsNull(Cmb_StatusView) Then
    If IsNull(cmb_BatchView) Then
        subfrmSQL = "SELECT NGSTest.Selection, Patients.PatientID AS PRU, NGSTest.NGSTestID, dbo_Patient_table.LastName, dbo_Patient_table.FirstName, dbo_Patient_table.DoB, gw_GenderTable.GenderShort, Referral.Referral, NGSTest.DateRequested, Checker.Name AS RefName, Checker.Initials AS Referrer, NGSPanel.Panel AS PanelA, NGSPanel_1.Panel AS PanelB, Status_1.StatusID AS PatientStatus, WESBatch.BatchName AS WESBatch, Status.StatusID, Status.Status AS TestStatus, NGSTest.ResultComment, Patients.InternalPatientID, Checker_1.Initials AS Checker1, NGSTest.Check1Date, Checker_2.Initials AS Checker2, NGSTest.Check2Date, Checker_3.Initials AS ReportApproved, NGSTest.Check3Date " & _
                    "FROM (((((((((((((NGSTest INNER JOIN Patients ON NGSTest.InternalPatientID = Patients.InternalPatientID) INNER JOIN Referral ON NGSTest.ReferralID = Referral.ReferralID) INNER JOIN Checker ON NGSTest.BookBy = Checker.Check1ID) INNER JOIN NGSPanel ON NGSTest.NGSPanelID = NGSPanel.NGSPanelID) LEFT JOIN NGSPanel AS NGSPanel_1 ON NGSTest.NGSPanelID_B = NGSPanel_1.NGSPanelID) INNER JOIN Status ON NGSTest.StatusID = Status.StatusID) INNER JOIN dbo_Patient_table ON Patients.PatientID = dbo_Patient_table.PatientTrustID) LEFT JOIN DNA ON NGSTest.DNA = DNA.DNANumber) INNER JOIN Status AS Status_1 ON Patients.s_StatusOverall = Status_1.StatusID) LEFT JOIN gw_GenderTable ON dbo_Patient_table.GenderID = gw_GenderTable.GenderID) LEFT JOIN WESBatch ON NGSTest.WESBatch = WESBatch.ID) LEFT JOIN Checker AS Checker_1 ON NGSTest.Check1ID = Checker_1.Check1ID) LEFT JOIN Checker AS Checker_2 ON NGSTest.Check2ID = Checker_2.Check1ID) LEFT JOIN Checker AS Checker_3 ON NGSTest.Check3ID = Checker_3.Check1ID " & _
                    "WHERE Status.StatusID = " & CStr(Me![Cmb_StatusView]) & " " & _
                    "ORDER BY NGSTest.DateRequested;"
                    
        'Debug.Print subfrmSQL
        [Form_s87020_ExomeLabList].Form.RecordSource = subfrmSQL
        Me.txt_displayed = "Sample with status: " + Me![Cmb_StatusView].Column(1)
        
        ' refresh total tally
        strCriteria = " TestStatus = '" & Me.Cmb_StatusView.Column(1) & "'"
        AllTotal = DCount("TestStatus", "s87020_ListWESSamples", strCriteria)
        Me.txt_TotalTally = AllTotal
    
    ' else display the subform filtered on batch and status option if a status has aready been selected
    Else
        subfrmSQL = "SELECT NGSTest.Selection, Patients.PatientID AS PRU, NGSTest.NGSTestID, dbo_Patient_table.LastName, dbo_Patient_table.FirstName, dbo_Patient_table.DoB, gw_GenderTable.GenderShort, Referral.Referral, NGSTest.DateRequested, Checker.Name AS RefName, Checker.Initials AS Referrer, NGSPanel.Panel AS PanelA, NGSPanel_1.Panel AS PanelB, Status_1.StatusID AS PatientStatus, WESBatch.BatchName AS WESBatch, Status.StatusID, Status.Status AS TestStatus, NGSTest.ResultComment, Patients.InternalPatientID, Checker_1.Initials AS Checker1, NGSTest.Check1Date, Checker_2.Initials AS Checker2, NGSTest.Check2Date, Checker_3.Initials AS ReportApproved, NGSTest.Check3Date " & _
                    "FROM (((((((((((((NGSTest INNER JOIN Patients ON NGSTest.InternalPatientID = Patients.InternalPatientID) INNER JOIN Referral ON NGSTest.ReferralID = Referral.ReferralID) INNER JOIN Checker ON NGSTest.BookBy = Checker.Check1ID) INNER JOIN NGSPanel ON NGSTest.NGSPanelID = NGSPanel.NGSPanelID) LEFT JOIN NGSPanel AS NGSPanel_1 ON NGSTest.NGSPanelID_B = NGSPanel_1.NGSPanelID) INNER JOIN Status ON NGSTest.StatusID = Status.StatusID) INNER JOIN dbo_Patient_table ON Patients.PatientID = dbo_Patient_table.PatientTrustID) LEFT JOIN DNA ON NGSTest.DNA = DNA.DNANumber) INNER JOIN Status AS Status_1 ON Patients.s_StatusOverall = Status_1.StatusID) LEFT JOIN gw_GenderTable ON dbo_Patient_table.GenderID = gw_GenderTable.GenderID) LEFT JOIN WESBatch ON NGSTest.WESBatch = WESBatch.ID) LEFT JOIN Checker AS Checker_1 ON NGSTest.Check1ID = Checker_1.Check1ID) LEFT JOIN Checker AS Checker_2 ON NGSTest.Check2ID = Checker_2.Check1ID) LEFT JOIN Checker AS Checker_3 ON NGSTest.Check3ID = Checker_3.Check1ID " & _
                    "WHERE ((Status_1.StatusID) = 1202218798) And NGSTest.WESBatch = " & CStr(Me![cmb_BatchView]) & " AND Status.StatusID = " & CStr(Cmb_StatusView) & " " & _
                    "ORDER BY NGSTest.DateRequested;"
                    
        'Debug.Print subfrmSQL
        [Form_s87020_ExomeLabList].Form.RecordSource = subfrmSQL
        Me.txt_displayed = "Batch " + Me![cmb_BatchView].Column(1) + " with status " + Me![Cmb_StatusView].Column(1)
        
        ' refresh total tally
        strCriteria = " WESBatch = '" & Me.cmb_BatchView.Column(1) & "' AND TestStatus = '" & Me.Cmb_StatusView.Column(1) & "'"
        AllTotal = DCount("TestStatus", "s87020_ListWESSamples", strCriteria)
        Me.txt_TotalTally = AllTotal
    End If
End If
End Sub


Private Sub cmb_StatusView_AfterUpdate()
' If Status filter is set to NULL update the subform to reflect the filtering criteria
' Either via batch search or view all
If IsNull(Cmb_StatusView) Then
    If Not IsNull(cmb_BatchView) Then
        Call cmb_BatchView_Click
Else
    Call btn_ViewAll_Click
    End If
End If
End Sub


Private Sub btn_Clear2_Click()
'clears users entry for viwing by status
Me.Cmb_StatusView = Null
Call cmb_StatusView_AfterUpdate
End Sub


Private Sub btn_BatchAssign_Click()
Dim rsWES As dao.Recordset
Dim rsAssign As dao.Recordset
Dim rsBatch As dao.Recordset
Dim batchTotal As Long
Dim selTotal As Long
Dim strSQL As String
Dim strAssign As String
Dim strUpd8Batch As String
Dim strNewBatch As String
Dim strLogSQL As String
Dim strLogSQL2 As String
Dim unsel As String
Dim strCriteria As String
Dim rsSQL As String
Dim newbatch As String
Dim usr As String
Dim dt As String
Dim comp As String
Dim strUpd8Status As String
Dim strLogMemo As String


dt = Format(Now, "dd/mmm/yyyy Hh:Nn:ss")
cmp = VBA.Environ("COMPUTERNAME")
usr = VBA.Environ("USERNAME")

' Checks that a WES batch has been selected
If IsNull(Me.cmb_BatchAssign) And IsNull(Me.txt_NEWBatch) Then
    msga = MsgBox("Unable to assign samples" & vbNewLine & "No WES batch specified", vbOKOnly Or vbExclamation, "No Batch Specified")
    cmb_BatchAssign.SetFocus
    Exit Sub
    
' Checks that only one option to assign a WES bach has been selected
ElseIf Not IsNull(Me.cmb_BatchAssign) And Not IsNull(Me.txt_NEWBatch) Then
    msgb = MsgBox("Unable to assign samples" & vbNewLine & "Please specify One WES batch option ONLY", vbOKOnly Or vbExclamation, "ATTENTION")
    btn_Clear4.SetFocus
    Exit Sub
     
' Assigning samples to a batch via drop down menu
ElseIf Not IsNull(Me.cmb_BatchAssign) And IsNull(Me.txt_NEWBatch) Then
    ' unselect any tests which are already associated with a WES batch and not in batching step of the pipeline--> will only assign tests which are not yet assigned to a batch
    unsel = "UPDATE NGSTest INNER JOIN Patients ON NGSTest.InternalPatientID = Patients.InternalPatientID SET NGSTest.Selection = 0 WHERE NGSTest.Selection = -1 AND (NGSTest.WESBatch is Not Null or NGSTest.statusID <> 1202218803)"
        DoCmd.SetWarnings False
        DoCmd.RunSQL unsel
        Form![s87020_ExomeLabList].Requery
        DoCmd.SetWarnings True
        
    'refresh selection count
    selTotal = DCount("[Selection]", "s87020_ListWESSamples", "[Selection] = -1")
    Me.txt_SelectionCount = selTotal
    
    ' check that at least one unassigned batching NGS test has been selected.
    If IsNull(selTotal) Or selTotal = 0 Then
        msgc = MsgBox("No unassigned tests requiring batching are selected", vbExclamation, "Attention")
    Else
        ' Count the number of samples already in the selected WES batch
        strCriteria = " WESBatch = '" & Me.cmb_BatchAssign.Column(1) & "'"
        batchTotal = DCount("WESBatch", "s87020_ListWESSamples", strCriteria)
        'Debug.Print "batch " & batchTotal
        
        ' confirm user decision.
        If MsgBox("Batch " & Me.cmb_BatchAssign.Column(1) & " currently consists of " & batchTotal & " tests." & vbNewLine & "You are about to assign an additional " & selTotal & " test(s) to batch " & Me.cmb_BatchAssign.Column(1) & vbNewLine & "This step can not be undone. Do you wish to proceed?", vbYesNo Or vbExclamation, "Assign to WES Batch?") = vbNo Then
            Cancel = True
            
        Else
            ' open record set for tests to be assigned loop through records and assign test to specified WES batch
            strAssign = "SELECT Patients.InternalPatientID, NGSTest.NGSTestID, NGSTest.Selection, ngstest.DateRequested " & _
                        "FROM (NGSTest INNER JOIN Patients ON NGSTest.InternalPatientID = Patients.InternalPatientID) " & _
                        "WHERE NGSTest.Selection= -1 ;"
            Set db = CurrentDb
            Set rsAssign = db.OpenRecordset(strAssign, dbOpenDynaset, dbSeeChanges)
            
            With rsAssign
             If Not .BOF And Not .EOF Then
                While (Not .EOF)

                    If rsAssign!Selection = -1 Then
                        strUpd8Batch = "UPDATE NGSTest SET WESBatch = " & Me.cmb_BatchAssign & " WHERE NGSTest.NGSTestID = " & rsAssign!NGSTestID
                        ' update the test status to nest step NextSEQ sequencing
                        strUpd8Status = "UPDATE NGSTest SET StatusID = 1202218804 WHERE NGSTest.NGSTestID = " & rsAssign!NGSTestID
                        'update patient log
                        strLogSQL = "INSERT INTO PatientLog(InternalPatientID, LogEntry, [Date], Login, PCName) VALUES(" & rsAssign!InternalPatientID & ", 'NGS WES test: NGS testID " & rsAssign!NGSTestID & " assigned to WES batch " & Me.cmb_BatchAssign.Column(1) & " (ID " & Me.cmb_BatchAssign.Column(0) & "). ',#" + dt + "#,'" + usr + "','" + cmp + "')"
                        strLogSQL2 = "INSERT INTO PatientLog(InternalPatientID, LogEntry, [Date], Login, PCName) VALUES(" & rsAssign!InternalPatientID & ", 'NGS WES test: Status updated to 1202218804 for test requested " & rsAssign!DateRequested & " NGS testID " & rsAssign!NGSTestID & ". ',#" + dt + "#,'" + usr + "','" + cmp + "')"
                        'update NGSlogmemo
                        strLogMemo = "INSERT INTO NGSLogMemo(InternalPatientID, Type, LinkID, LogMemoEntry, [Date], Login, PCName) VALUES(" + CStr(rsAssign!InternalPatientID) + ", 1, " + CStr(rsAssign!NGSTestID) + ",'NGS WES test status updated to NextSEQ sequencing.' ,#" + dt + "#,'" + usr + "','" + cn + "')"
                        'Debug.Print strLogMemo
                        
                        DoCmd.SetWarnings False
                        DoCmd.RunSQL strUpd8Batch
                        DoCmd.RunSQL strUpd8Status
                        DoCmd.RunSQL strLogSQL
                        DoCmd.RunSQL strLogSQL2
                        DoCmd.RunSQL strLogMemo
                        'Debug.Print "insert sql"
                        DoCmd.SetWarnings True
                        .MoveNext

                    Else
                        .MoveNext
                    End If
                Wend
             End If
            End With
            Set rsAssign = Nothing
            Set db = Nothing
        End If
    Call btn_ViewAll_Click
    Exit Sub
    End If
        
                '///////////////////////////////////////////

' Create a new batch and assign samples (text box option)
ElseIf IsNull(Me.cmb_BatchAssign) And Not IsNull(Me.txt_NEWBatch) Then
    '1) check entry is an interger
    If Not IsNumeric(Me.txt_NEWBatch) Then
        msgb = MsgBox("Only numbers maybe entered when creating a new WES batch", vbExclamation, "ATTENTION")
        Me.txt_NEWBatch = Null
       
    Else
    '2) Add WES prefix then test if batch name has already been defined
    newbatch = "WES" + CStr(Me.txt_NEWBatch)
    Debug.Print newbatch
    strSQL = "SELECT * FROM WESBatch WHERE BatchName = '" + newbatch + "'"
    Debug.Print strSQL
    Set db = CurrentDb
    Set rsWES = db.OpenRecordset(strSQL, dbOpenDynaset, dbSeeChanges)
        If rsWES.EOF Then 'checks entry is a unique name
            strNewBatch = "INSERT INTO WESBatch(BatchName) VALUES ('" + newbatch + "')"
            
            ' Debug.Print strNewBatch
            ' Add batch name into WESBatch table
            
            ' unselect any tests/ samples which are already associated with a WES batch and not in batching stage --> will only assign tests which are not yet assigned to a batch
            unsel = "UPDATE NGSTest INNER JOIN Patients ON NGSTest.InternalPatientID = Patients.InternalPatientID SET NGSTest.Selection = 0 WHERE NGSTest.Selection = -1 AND (NGSTest.WESBatch is Not Null or NGSTest.statusID <> 1202218803)"
                DoCmd.SetWarnings False
                DoCmd.RunSQL unsel
                'DoCmd.RunSQL strNewBatch
                Form![s87020_ExomeLabList].Requery
                DoCmd.SetWarnings True
                
            'refresh selection count
            selTotal = DCount("[Selection]", "s87020_ListWESSamples", "[Selection] = -1")
            Me.txt_SelectionCount = selTotal
            
            ' Check at least 1 sample remains selected
            If IsNull(selTotal) Or selTotal = 0 Then
                 msgc = MsgBox("No unassigned tests requiring batching are selected", vbExclamation, "Attention")
                 txt_NEWBatch.SetFocus
                 Exit Sub
            Else
            ' open record set for tests to be assigned loop through records are and assign test to specified WES batch
            ' confirm user decision.
                If MsgBox("You are about to assign " & selTotal & " test(s) to the new batch " + newbatch + vbNewLine & "This step can not be undone." & vbNewLine & "Do you wish to proceed?", vbYesNo Or vbExclamation, "Assign to WES Batch?") = vbNo Then
                    Cancel = True
                    
                Else
                    ' Add batch name into WESBatch table
                    DoCmd.SetWarnings False
                    DoCmd.RunSQL strNewBatch
                    DoCmd.SetWarnings True
                    
                    strAssign = "SELECT Patients.InternalPatientID, NGSTest.NGSTestID, NGSTest.Selection, NGSTest.Daterequested " & _
                                "FROM (NGSTest INNER JOIN Patients ON NGSTest.InternalPatientID = Patients.InternalPatientID) " & _
                                "WHERE NGSTest.Selection= -1 ;"
                    strbatchID = "SELECT ID From WESBatch Where batchname = '" + newbatch + "'"
                   
                    Set db = CurrentDb
                    Set rsAssign = db.OpenRecordset(strAssign, dbOpenDynaset, dbSeeChanges)
                    Set rsBatch = db.OpenRecordset(strbatchID, dbOpenDynaset, dbSeeChanges)
                
                    With rsAssign
                     If Not .BOF And Not .EOF Then
                        While (Not .EOF)
                            If rsAssign!Selection = -1 Then
                                strUpd8Batch = "UPDATE NGSTest SET WESBatch = " & rsBatch!ID & " WHERE NGSTest.NGSTestID = " & rsAssign!NGSTestID
                                ' update the test status to nest step NextSEQ sequencing
                                strUpd8Status = "UPDATE NGSTest SET StatusID = 1202218804 WHERE NGSTest.NGSTestID = " & rsAssign!NGSTestID
                                ' update patient log
                                strLogSQL = "INSERT INTO PatientLog(InternalPatientID, LogEntry, [Date], Login, PCName) VALUES(" & rsAssign!InternalPatientID & ", 'NGS WES test: NGS testID " & rsAssign!NGSTestID & " assigned to WES batch " + newbatch + " (ID " & rsBatch!ID & "). ',#" + dt + "#,'" + usr + "','" + cmp + "')"
                                strLogSQL2 = "INSERT INTO PatientLog(InternalPatientID, LogEntry, [Date], Login, PCName) VALUES(" & rsAssign!InternalPatientID & ", 'NGS WES test: Status updated to 1202218804 for test requested " & rsAssign!DateRequested & " NGS testID " & rsAssign!NGSTestID & ". ',#" + dt + "#,'" + usr + "','" + cmp + "')"
                                'update NGSlogmemo
                                strLogMemo = "INSERT INTO NGSLogMemo(InternalPatientID, Type, LinkID, LogMemoEntry, [Date], Login, PCName) VALUES(" + CStr(rsAssign!InternalPatientID) + ", 1, " + CStr(rsAssign!NGSTestID) + ",'NGS WES test status updated to NextSEQ sequencing.' ,#" + dt + "#,'" + usr + "','" + cn + "')"
    
                                DoCmd.SetWarnings False
                                DoCmd.RunSQL strUpd8Batch
                                DoCmd.RunSQL strUpd8Status
                                DoCmd.RunSQL strLogSQL
                                DoCmd.RunSQL strLogSQL2
                                DoCmd.RunSQL strLogMemo
                                DoCmd.SetWarnings True
                                .MoveNext
                                               
                            Else
                                .MoveNext
                            End If
                        Wend
                     End If
                    End With
                    Set reWES = Nothing
                    Set rsAssign = Nothing
                    Set rsBatch = Nothing
                    Set db = Nothing
                End If
            End If
        Else
            msgd = MsgBox("WES batch: " + newbatch + " already exists." & vbNewLine & "Please select a WES Batch from the dropdown menu or enter a new batch name.", vbExclamation, "WES Batch Already Exists")
            Exit Sub
        End If
    Call btn_ViewAll_Click
    Exit Sub
End If
End If
End Sub

Private Sub btn_Clear4_Click()
Me.cmb_BatchAssign = Null
Me.txt_NEWBatch = Null
End Sub


Private Sub btn_UpdateStatus_Click()
Dim rsStatus As dao.Recordset
Dim selTotal As Long
Dim strStatus As String
Dim usr As String
Dim dt As String
Dim comp As String


dt = Format(Now, "dd/mmm/yyyy Hh:Nn:ss")
cmp = VBA.Environ("COMPUTERNAME")
usr = VBA.Environ("USERNAME")
' check if null
' check a sample has been selected
' confirm Selection
' update
' log change
If IsNull(Me.cmb_StatusUpdate) Then
    msga = MsgBox("Unable to assign samples" & vbNewLine & "No status selected", vbOKOnly Or vbExclamation, "No Status Specified")
    cmb_updatestatus.SetFocus
    Exit Sub
Else
    'refresh selection count
    selTotal = DCount("[Selection]", "s87020_ListWESSamples", "[Selection] = -1")
    Me.txt_SelectionCount = selTotal
    
    ' Check at least 1 sample remains selected
    If IsNull(selTotal) Or selTotal = 0 Then
        msgc = MsgBox("No WES tests selected", vbExclamation, "Attention")
        txt_NEWBatch.SetFocus
        Exit Sub
    Else
    ' open record set for tests to be assigned loop through records are and update tests status
    ' confirm user decision.
        If MsgBox("You are about to update the status of " & selTotal & " test(s) to '" + Me!cmb_StatusUpdate.Column(1) + "'" & vbNewLine & "Do you wish to proceed?", vbYesNo Or vbExclamation, "Assign to WES Batch?") = vbNo Then
            Cancel = True
                
        Else
            strStatus = "SELECT Patients.InternalPatientID, NGSTest.NGSTestID, NGSTest.Selection, NGSTest.StatusID " & _
                         "FROM (NGSTest INNER JOIN Patients ON NGSTest.InternalPatientID = Patients.InternalPatientID) " & _
                         "WHERE NGSTest.Selection= -1;"
                         
            Set db = CurrentDb
            Set rsStatus = db.OpenRecordset(strStatus, dbOpenDynaset, dbSeeChanges)
            With rsStatus
            
'            fred = " " & Me!cmb_StatusUpdate.Column(0)
                 If Not .BOF And Not .EOF Then
                    While (Not .EOF)
                        If rsStatus!Selection = -1 And Trim(rsStatus!StatusID) <> Me!cmb_StatusUpdate.Column(0) Then
                        
                        
                        'strLogSQL = "INSERT INTO PatientLog(InternalPatientID, LogEntry, [Date], Login, PCName) VALUES(" & rsAssign!InternalPatientID & ", 'NGS WES test:Status updated to " + Me!cmbStatusUpdate.Column(1) + " for test requested " & rsAssign!NGSTestID & ". ',#" + dt + "#,'" + usr + "','" + cmp + "')"
               Dim rc As String
        'Debug.Print " test"
        rc = Replace(Me![txt_Resultcmt], "'", "''")
        S = "INSERT INTO PatientLogMemo(InternalPatientID, ArrayTestID, LogMemoEntry, [Date], Login, PCName) VALUES(" + CStr(Me![InternalPatientID]) + "," + CStr(Me![NGSTestID]) + ",'NGS WES test: Result comment updated for WES test requested " + CStr(Me![DateRequested]) + " - " + rc + "',#" + dt + "#,'" + usr + "','" + cn + "')"
        'Debug.Print S
              
                        .MoveNext
                       Else
                        .MoveNext
                        End If
                    Wend
                 End If
            End With
        End If
    End If
End If
End Sub
                    
            
Private Sub btn_Clear3_Click()
'clears user entry for update status
Me.cmb_StatusUpdate = Null
End Sub
