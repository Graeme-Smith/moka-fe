Option Compare Database
Private internalPatID As String
Private ExomeTestID As String
Private ReferralID As String
Private Referral As String
Private Sub Form_Load()
    Dim openArgs() As String
    Dim patientID_PRU As String
    Dim username As String
    Dim todayDate As String
    Dim panelName As String
    Dim sql1 As String

    'Assign default values
    Me![Category] = 692 'Clinician
    Me![SubCategory] = 693 'Candidate gene
    Me![Checker1] = 1201865468 'Clinician
    Me![CheckDate] = Format(Now(), "dd/mmm/yyyy Hh:Nn:ss")

    'Retrieve PatientID_PRU and ExomeTestID passed from ExomeTest form
    openArgs = Split(Me.openArgs, ", ")
    internalPatID = openArgs(0)
    patientID_PRU = openArgs(1)
    ExomeTestID = openArgs(2)
    ReferralID = openArgs(3)
    Referral = openArgs(4)

    'Set panel name
    username = VBA.Environ("USERNAME")
    todayDate = Format(Now(), "yymmdd")
    panelName = username & "_" & patientID_PRU & "_" & todayDate
    Me![Panel] = panelName

    'Set panel code
    Me![PanelCode] = "Pan" & Me![NGSPanelID]

    'Add NGSPanelID to ExomeTest record
    sql1 = "UPDATE ExomeTest SET NGSPanelID = " & Me![NGSPanelID] & " WHERE ExomeTestID = " & ExomeTestID
    DoCmd.SetWarnings False
    DoCmd.RunSQL sql1
    DoCmd.SetWarnings True
End Sub

Private Sub addGene_Click()
    Dim sql2 As String

    'Add selected gene to gene panel
    If Not IsNull(Me![GeneSymbol]) Then
        sql2 = "INSERT INTO NGSPanelGenes ( NGSPanelID, symbol, HGNCID) VALUES (" & Me![NGSPanelID] & ", '" & Me![GeneSymbol] & "', '" & Me![GeneSymbol].Column(1) & "')"
        DoCmd.SetWarnings False
        DoCmd.RunSQL sql2
        DoCmd.SetWarnings True
        Me![GenePanelListBox].Value = Null
        Me![GenePanelListBox].Requery
        Me![GeneSymbol] = Null
    End If
End Sub

Private Sub GeneSymbol_NotInList(NewData As String, Response As Integer)
    'Replaces default error message if gene not in list
    MsgBox "Gene symbol not recognised. Please enter approved gene symbol from dropdown list.", vbExclamation, "Gene Not Found"
    Response = acDataErrContinue
    Me![GeneSymbol] = Null
End Sub

Private Sub HGNCLaunch_Click()
    Dim url As String
    Dim pathFireFox As String
    'Launch Phenotips in firefox
    url = "http://www.genenames.org/"
    pathFireFox = "C:\Program Files (x86)\Mozilla Firefox\firefox.exe"
    If Dir(pathFireFox) = "" Then
        pathFireFox = "C:\Program Files\Mozilla Firefox\firefox.exe"
    End If
    If Dir(pathFireFox) = "" Then
        MsgBox "FireFox path not found," & vbNewLine & "FireFox required to launch HGNC.", vbCritical, "ERROR"
        Exit Sub
    End If
    Shell """" & pathFireFox & """" & " -new-tab " & url, vbHide
End Sub

Private Sub removeGene_Click()
    Dim sql3 As String
    'If no gene is selected, display error message
    If IsNull(Me![GenePanelListBox].Value) Then
        MsgBox "No gene selected.", vbExclamation, "No Gene Selected"
    'Delete gene from panel and update list box
    Else
        sql3 = "DELETE FROM NGSPanelGenes WHERE NGSPanelGenesID = " & Me![GenePanelListBox].Value
        DoCmd.SetWarnings False
        DoCmd.RunSQL sql3
        DoCmd.SetWarnings True
        Me![GenePanelListBox].Value = Null
        Me![GenePanelListBox].Requery
    End If
End Sub

Private Sub ExtendedPanelCombo_NotInList(NewData As String, Response As Integer)
    'Replaces default error message if referal type not in list
    MsgBox "Gene panel not recognised. Please select from the dropdown list", vbExclamation, "Select Extended Gene Panel"
    Response = acDataErrContinue
    Me!ExtendedPanelCombo = Null
End Sub

Private Sub ExtendedPanelCombo_AfterUpdate()
    'Update extended panel code and name fields after selection
    Me![ExtendedPanelCode] = Me![ExtendedPanelCombo].Column(1)
    Me![ExtendedPanelName] = Me![ExtendedPanelCombo].Column(2)

    'Update Extended Panel listbox
    Me![ExtPanListbox].Requery
End Sub

Private Sub SubmitButton_Click()
    Dim sql4 As String
    Dim sql5 As String
    Dim d As String
    Dim un As String
    Dim cn As String

    'Add Extended NGSPanelID to ExomeTest record
    If Not IsNull(Me![ExtendedPanelCombo]) Then
        sql4 = "UPDATE ExomeTest SET ExtendedPanelID = " & Me![ExtendedPanelCombo] & " WHERE ExomeTestID = " & ExomeTestID
        DoCmd.SetWarnings False
        DoCmd.RunSQL sql4
        DoCmd.SetWarnings True
    End If

    'Insert record of Exome test request into patient log
    d = Format(Now(), "dd/mmm/yyyy Hh:Nn:ss")
    un = VBA.Environ("USERNAME")
    cn = VBA.Environ("COMPUTERNAME")
    sql5 = "INSERT INTO PatientLog(InternalPatientID, LogEntry, [Date], Login, PCName) VALUES(" & internalPatID & ", 'NGS: " & Referral & " test request added. Main panel: " & Me![PanelCode] & ". Extended panel: " & Me![ExtendedPanelCode] & "',#" + d + "#,'" + un + "','" + cn + "')"
    DoCmd.SetWarnings False
    DoCmd.RunSQL sql5
    DoCmd.SetWarnings True

    'Display message and close form
    MsgBox "Exome test request submitted." & vbNewLine & vbNewLine & "Pending authorisation.", vbInformation, "Test Request Submitted"
    DoCmd.Close
End Sub
